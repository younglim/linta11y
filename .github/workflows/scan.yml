name: Accessibility Scanner

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: 'GitHub Repo URL to scan'
        required: true
        type: string

jobs:
  clean-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Host Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Golden Set Dependencies
        run: |
          npm install \
            eslint@8.57.0 \
            typescript@5.4.5 \
            @typescript-eslint/parser@7.8.0 \
            @typescript-eslint/eslint-plugin@7.8.0 \
            eslint-plugin-jsx-a11y@6.8.0 \
            eslint-plugin-react@7.34.1 \
            eslint-plugin-react-native-a11y@3.3.0 \
            eslint-plugin-vue@9.25.0 \
            eslint-plugin-vuejs-accessibility@2.3.0 \
            vue-eslint-parser@9.4.2 \
            @html-eslint/parser@0.24.1 \
            @html-eslint/eslint-plugin@0.24.1

      - name: Clone Target Repository
        run: |
          git clone --depth 1 ${{ inputs.target_repo_url }} ./target-code

      - name: Generate Configurations
        run: |
          # --- UNIVERSAL CONFIG ---
          cat << 'EOF' > .eslintrc-universal.json
          {
            "root": true,
            "env": { "browser": true, "es2021": true, "node": true },
            "overrides": [
              {
                "files": ["*.html"],
                "parser": "@html-eslint/parser",
                "plugins": ["@html-eslint"],
                "extends": ["plugin:@html-eslint/recommended"],
                "rules": {
                  "@html-eslint/require-img-alt": "error",
                  "@html-eslint/require-lang": "error",
                  "@html-eslint/require-title": "error",
                  "@html-eslint/no-abstract-roles": "error",
                  "@html-eslint/no-accesskey-attrs": "error",
                  "@html-eslint/require-button-type": "error",
                  "@html-eslint/require-li-container": "error"
                }
              },
              {
                "files": ["*.jsx", "*.tsx", "*.js", "*.ts"],
                "parser": "@typescript-eslint/parser",
                "parserOptions": { "ecmaVersion": 2020, "sourceType": "module", "ecmaFeatures": { "jsx": true } },
                "plugins": ["jsx-a11y", "react", "react-native-a11y", "@typescript-eslint"],
                "extends": ["plugin:jsx-a11y/strict", "plugin:react-native-a11y/all"],
                "rules": {
                  "react/jsx-uses-react": "off",
                  "react/react-in-jsx-scope": "off",
                  "jsx-a11y/anchor-is-valid": "off",
                  "react-native-a11y/has-accessibility-hint": "off"
                }
              },
              {
                "files": ["*.vue"],
                "parser": "vue-eslint-parser",
                "parserOptions": {
                  "parser": "@typescript-eslint/parser",
                  "ecmaVersion": 2020,
                  "sourceType": "module",
                  "extraFileExtensions": [".vue"]
                },
                "plugins": ["vue", "vuejs-accessibility"],
                "extends": ["plugin:vue/essential", "plugin:vuejs-accessibility/recommended"]
              }
            ]
          }
          EOF

          # --- STRICT FILTER & MAPPER ---
          cat << 'EOF' > map-wcag.js
          const fs = require('fs');
          
          // STRICT ALLOWLIST: Any rule NOT in this list is discarded.
          const ruleMap = {
            // HTML RULES
            '@html-eslint/require-img-alt': 'WCAG 1.1.1 (Non-text Content)',
            '@html-eslint/require-lang': 'WCAG 3.1.1 (Language of Page)',
            '@html-eslint/require-title': 'WCAG 2.4.2 (Page Titled)',
            '@html-eslint/no-accesskey-attrs': 'WCAG 2.1.1 (Keyboard)',
            '@html-eslint/require-button-type': 'WCAG 4.1.2 (Name, Role, Value)',
            '@html-eslint/no-abstract-roles': 'WCAG 4.1.2 (Name, Role, Value)',
            
            // WEB (React/JSX)
            'jsx-a11y/alt-text': 'WCAG 1.1.1 (Non-text Content)',
            'jsx-a11y/anchor-has-content': 'WCAG 2.4.4 (Link Purpose)',
            'jsx-a11y/anchor-is-valid': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/click-events-have-key-events': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/no-static-element-interactions': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/interactive-supports-focus': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/label-has-associated-control': 'WCAG 1.3.1 (Info and Relationships)',
            'jsx-a11y/control-has-associated-label': 'WCAG 4.1.2 (Name, Role, Value)',
            'jsx-a11y/mouse-events-have-key-events': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/heading-has-content': 'WCAG 1.3.1 (Info and Relationships)',
            'jsx-a11y/html-has-lang': 'WCAG 3.1.1 (Language of Page)',
            'jsx-a11y/iframe-has-title': 'WCAG 2.4.1 (Bypass Blocks)',
            'jsx-a11y/no-autofocus': 'WCAG 2.4.3 (Focus Order)',
            'jsx-a11y/no-noninteractive-element-interactions': 'WCAG 4.1.2 (Name, Role, Value)',
            'jsx-a11y/aria-props': 'WCAG 4.1.2 (Name, Role, Value)',
            'jsx-a11y/aria-role': 'WCAG 4.1.2 (Name, Role, Value)',
            'jsx-a11y/aria-unsupported-elements': 'WCAG 4.1.2 (Name, Role, Value)',
            
            // REACT NATIVE
            'react-native-a11y/accessibility-label': 'WCAG 1.1.1 (Non-text Content)',
            'react-native-a11y/accessible-image-has-label': 'WCAG 1.1.1 (Non-text Content)',
            'react-native-a11y/accessibility-role': 'WCAG 4.1.2 (Name, Role, Value)',
            'react-native-a11y/has-valid-accessibility-state': 'WCAG 4.1.2 (Name, Role, Value)',
            'react-native-a11y/has-valid-accessibility-value': 'WCAG 4.1.2 (Name, Role, Value)',
            'react-native-a11y/no-nested-touchables': 'WCAG 2.5.2 (Pointer Cancellation)',
            
            // VUE.JS
            'vuejs-accessibility/alt-text': 'WCAG 1.1.1 (Non-text Content)',
            'vuejs-accessibility/form-control-has-label': 'WCAG 1.3.1 (Info and Relationships)',
            'vuejs-accessibility/anchor-has-content': 'WCAG 2.4.4 (Link Purpose)',
            'vuejs-accessibility/click-events-have-key-events': 'WCAG 2.1.1 (Keyboard)',
            'vuejs-accessibility/label-has-for': 'WCAG 1.3.1 (Info and Relationships)',
            'vuejs-accessibility/no-autofocus': 'WCAG 2.4.3 (Focus Order)',
            'vuejs-accessibility/heading-has-content': 'WCAG 1.3.1 (Info and Relationships)',
            'vuejs-accessibility/iframe-has-title': 'WCAG 2.4.1 (Bypass Blocks)',
            'vuejs-accessibility/interactive-supports-focus': 'WCAG 2.1.1 (Keyboard)',
            'vuejs-accessibility/mouse-events-have-key-events': 'WCAG 2.1.1 (Keyboard)'
          };
          
          try {
            if (!fs.existsSync('eslint-raw.json')) process.exit(0);
            const content = fs.readFileSync('eslint-raw.json', 'utf8');
            if (!content) process.exit(0);

            let report;
            try { report = JSON.parse(content); } catch (e) { process.exit(0); }

            const cleanReport = report.map(f => {
              // 1. FILTER: Only keep messages that exist in our Allowlist (ruleMap)
              const validMessages = f.messages.filter(m => ruleMap[m.ruleId]);

              if (validMessages.length === 0) return null; // Drop file if no relevant errors
              
              f.filePath = f.filePath.split('/target-code/')[1] || f.filePath;
              
              // 2. MAP: Add WCAG clause
              f.messages = validMessages.map(m => ({ 
                ...m, 
                wcagClause: ruleMap[m.ruleId] 
              }));
              
              return f;
            }).filter(Boolean);
            
            fs.writeFileSync('accessibility-report.json', JSON.stringify(cleanReport, null, 2));
            console.log(`âœ… Clean Report Generated: ${cleanReport.length} files with A11y issues.`);
          } catch (e) { console.error("Script Error:", e); }
          EOF

      - name: Execute Universal Scan
        continue-on-error: true
        run: |
          npx eslint ./target-code \
          --config .eslintrc-universal.json \
          --no-eslintrc \
          --ext .js,.jsx,.ts,.tsx,.vue,.html \
          --resolve-plugins-relative-to . \
          --format json \
          -o eslint-raw.json

      - name: Enrich and Filter Report
        run: node map-wcag.js

      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.run_id }}
          path: accessibility-report.json
