name: üöÄ Universal A11y Scanner

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: 'GitHub Repo URL to scan'
        required: true
        type: string
      target_branch:
        description: 'Branch to scan (e.g. starter). Leave empty for default.'
        required: false
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Host Repo
        uses: actions/checkout@v4

      # Use Node 20 (We are now fully modern!)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Scanner Engine
        # 1. Install dependencies from package.json
        # 2. Force install 'stylelint-a11y' (missing in your package.json)
        # 3. Force 'eslint@8' (to support your .eslintrc.json legacy format)
        run: |
          npm install
          npm install stylelint-a11y eslint@8.57.0 --save-dev

      - name: Clone Target Repository
        run: |
          if [ -n "${{ inputs.target_branch }}" ]; then
            echo "üìç Cloning specific branch: ${{ inputs.target_branch }}"
            git clone --depth 1 --branch ${{ inputs.target_branch }} ${{ inputs.target_repo_url }} ./target-code
          else
            echo "üìç Cloning default branch"
            git clone --depth 1 ${{ inputs.target_repo_url }} ./target-code
          fi

      - name: Run ESLint (JS/TS/HTML/Vue)
        continue-on-error: true
        run: |
          npx eslint "./target-code/**/*.{js,jsx,ts,tsx,vue,html}" \
            --config .eslintrc.json \
            --format json \
            --output-file eslint-raw.json

      - name: Run Stylelint (CSS/SCSS)
        continue-on-error: true
        run: |
          npx stylelint "./target-code/**/*.{css,scss,sass,less,vue}" \
            --config .stylelintrc.json \
            --formatter json \
            --output-file stylelint-raw.json \
            --allow-empty-input || true

      - name: Generate JSON Data
        env:
          TARGET_REPO_URL: ${{ github.event.inputs.target_repo_url }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
        run: node map-wcag.js

      - name: Generate HTML Report
        run: node generate-html.js

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.run_id }}
          path: |
            accessibility-report.json
            accessibility-report.html
