name: üïµÔ∏è‚Äç‚ôÄÔ∏è Remote Accessibility Scanner (RN + Web)

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: 'GitHub Repo URL to scan (e.g. https://github.com/user/repo)'
        required: true
        type: string

jobs:
  remote-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Host Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # FIX 1: Install React Native A11y Plugin
      # We kept eslint pinned to v8 to support the CLI flags you are using
      - name: Install Scanner Engine
        run: |
          npm install \
            eslint@^8.57.0 \
            eslint-plugin-jsx-a11y \
            eslint-plugin-react \
            eslint-plugin-react-native-a11y \
            @typescript-eslint/parser \
            @typescript-eslint/eslint-plugin \
            typescript

      - name: Clone Target Repository
        run: |
          git clone ${{ inputs.target_repo_url }} ./target-code

      - name: Generate Configurations
        run: |
          # --- Create ESLint Config ---
          # We now extend 'plugin:react-native-a11y/all' to catch mobile issues
          cat << 'EOF' > .eslintrc-temp.json
          {
            "root": true,
            "parser": "@typescript-eslint/parser",
            "parserOptions": {
              "ecmaVersion": 2020,
              "sourceType": "module",
              "ecmaFeatures": {
                "jsx": true
              }
            },
            "plugins": ["jsx-a11y", "react", "react-native-a11y", "@typescript-eslint"],
            "extends": [
              "plugin:jsx-a11y/strict",
              "plugin:react-native-a11y/all"
            ],
            "rules": {
              "react/jsx-uses-react": "off",
              "react/react-in-jsx-scope": "off",
              "jsx-a11y/anchor-is-valid": "off",
              "react-native-a11y/has-accessibility-hint": "off"
            }
          }
          EOF

          # --- Create WCAG Mapper Script ---
          # Updated to include Mobile A11y Rules
          cat << 'EOF' > map-wcag.js
          const fs = require('fs');
          
          const ruleMap = {
            // WEB RULES
            'jsx-a11y/alt-text': 'WCAG 1.1.1 (Non-text Content)',
            'jsx-a11y/anchor-has-content': 'WCAG 2.4.4 (Link Purpose)',
            'jsx-a11y/click-events-have-key-events': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/no-static-element-interactions': 'WCAG 2.1.1 (Keyboard)',
            'jsx-a11y/label-has-associated-control': 'WCAG 1.3.1 (Info and Relationships)',
            
            // REACT NATIVE RULES
            'react-native-a11y/accessibility-label': 'WCAG 1.1.1 (Non-text Content)',
            'react-native-a11y/accessible-image-has-label': 'WCAG 1.1.1 (Non-text Content)',
            'react-native-a11y/accessibility-role': 'WCAG 4.1.2 (Name, Role, Value)',
            'react-native-a11y/has-valid-accessibility-state': 'WCAG 4.1.2 (Name, Role, Value)',
            'react-native-a11y/has-valid-accessibility-value': 'WCAG 4.1.2 (Name, Role, Value)',
            'react-native-a11y/no-nested-touchables': 'WCAG 2.5.2 (Pointer Cancellation)'
          };
          
          try {
            if (!fs.existsSync('eslint-raw.json')) { 
              console.log("No raw report found."); 
              process.exit(0); 
            }
            
            const content = fs.readFileSync('eslint-raw.json', 'utf8');
            if (!content) {
               console.log("Report is empty.");
               process.exit(0);
            }

            const report = JSON.parse(content);
            
            const enriched = report.map(f => {
              if (f.messages.length === 0) return null;

              // Clean up path for readability
              f.filePath = f.filePath.split('/target-code/')[1] || f.filePath;
              
              f.messages = f.messages.map(m => {
                if (m.message && m.message.includes("Parsing error")) {
                   return { ...m, wcagClause: "Tool Configuration Error" };
                }
                return { 
                  ...m, 
                  wcagClause: ruleMap[m.ruleId] || 'Unmapped / Best Practice' 
                };
              });
              return f;
            }).filter(Boolean);
            
            fs.writeFileSync('accessibility-report.json', JSON.stringify(enriched, null, 2));
            console.log(`‚úÖ Report generated. Found issues in ${enriched.length} files.`);
          } catch (e) { 
            console.error("Error processing JSON:", e); 
          }
          EOF

      - name: Execute Scan
        continue-on-error: true
        run: |
          npx eslint ./target-code \
          --config .eslintrc-temp.json \
          --no-eslintrc \
          --ext .js,.jsx,.ts,.tsx \
          --format json \
          -o eslint-raw.json

      - name: Enrich with WCAG Data
        run: node map-wcag.js

      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.run_id }}
          path: accessibility-report.json
