name: Universal A11y Scanner

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: 'GitHub Repo URL to scan'
        required: true
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Host Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache: 'npm'  <-- REMOVED: Caused the error because package-lock.json is missing

      - name: Install Scanner Engine
        # CHANGED: 'npm ci' -> 'npm install' (install generates the lockfile on the fly)
        run: npm install

      - name: Clone Target Repository
        run: |
          git clone --depth 1 ${{ inputs.target_repo_url }} ./target-code

      - name: Run ESLint (Script/HTML)
        continue-on-error: true
        run: |
          npx eslint ./target-code \
            --no-eslintrc \
            --config .eslintrc.json \
            --ext .js,.jsx,.ts,.tsx,.vue,.html \
            --resolve-plugins-relative-to . \
            --format json \
            -o eslint-raw.json

      - name: Run Stylelint (CSS/SCSS)
        continue-on-error: true
        run: |
          npx stylelint "./target-code/**/*.{css,scss,less,sass}" \
            --config .stylelintrc.json \
            --formatter json \
            --allow-empty-input \
            > stylelint-raw.json

      - name: Generate Report
        run: node map-wcag.js

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.run_id }}
          path: accessibility-report.json
