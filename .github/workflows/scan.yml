name: Accessibility Scanner

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: 'GitHub Repo URL to scan'
        required: true
        type: string

jobs:
  total-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Host Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Golden Set Dependencies
        run: |
          npm install --legacy-peer-deps \
            eslint@8.57.0 \
            typescript@5.4.5 \
            @typescript-eslint/parser@7.8.0 \
            @typescript-eslint/eslint-plugin@7.8.0 \
            eslint-plugin-jsx-a11y@6.8.0 \
            eslint-plugin-react@7.34.1 \
            eslint-plugin-react-native-a11y@3.3.0 \
            eslint-plugin-vue@9.25.0 \
            eslint-plugin-vuejs-accessibility@2.3.0 \
            vue-eslint-parser@9.4.2 \
            @html-eslint/parser@0.24.1 \
            @html-eslint/eslint-plugin@0.24.1 \
            @angular-eslint/eslint-plugin@17.3.0 \
            @angular-eslint/template-parser@17.3.0 \
            stylelint@16.2.0 \
            stylelint-config-standard@36.0.0 \
            stylelint-a11y@1.2.3
              
      - name: Clone Target Repository
        run: |
          git clone --depth 1 ${{ inputs.target_repo_url }} ./target-code

      - name: Generate Configurations
        run: |
          # --- ESLINT CONFIG (JS/HTML/Frameworks) ---
          cat << 'EOF' > .eslintrc-universal.json
          {
            "root": true,
            "env": { "browser": true, "es2021": true, "node": true },
            "overrides": [
              {
                "files": ["*.html"],
                "parser": "@angular-eslint/template-parser",
                "plugins": ["@angular-eslint/template"],
                "extends": ["plugin:@angular-eslint/template/accessibility"]
              },
              {
                "files": ["*.jsx", "*.tsx", "*.js", "*.ts"],
                "parser": "@typescript-eslint/parser",
                "parserOptions": { "ecmaVersion": 2020, "sourceType": "module", "ecmaFeatures": { "jsx": true } },
                "plugins": ["jsx-a11y", "react", "react-native-a11y", "@typescript-eslint"],
                "extends": ["plugin:jsx-a11y/strict", "plugin:react-native-a11y/all"],
                "rules": {
                  "react/jsx-uses-react": "off",
                  "react/react-in-jsx-scope": "off",
                  "jsx-a11y/anchor-is-valid": "off",
                  "react-native-a11y/has-accessibility-hint": "off"
                }
              },
              {
                "files": ["*.vue"],
                "parser": "vue-eslint-parser",
                "parserOptions": { "parser": "@typescript-eslint/parser", "extraFileExtensions": [".vue"] },
                "plugins": ["vue", "vuejs-accessibility"],
                "extends": ["plugin:vue/essential", "plugin:vuejs-accessibility/recommended"]
              }
            ]
          }
          EOF

          # --- STYLELINT CONFIG (CSS/SCSS/LESS) ---
          cat << 'EOF' > .stylelintrc.json
          {
            "extends": ["stylelint-config-standard"],
            "plugins": ["stylelint-a11y"],
            "rules": {
              "a11y/media-prefers-reduced-motion": true,
              "a11y/no-outline-none": true,
              "a11y/selector-pseudo-class-focus": true,
              "a11y/content-property-no-static-value": true,
              "a11y/font-size-is-readable": true,
              "a11y/no-display-none": null,
              "a11y/no-obsolete-attribute": true,
              "a11y/no-text-align-justify": true,
              "custom-property-pattern": null,
              "selector-class-pattern": null,
              "selector-id-pattern": null,
              "no-descending-specificity": null
            }
          }
          EOF

          # --- MERGE & MAPPER SCRIPT ---
          cat << 'EOF' > map-wcag.js
          const fs = require('fs');

          // --- 1. DEFINE RULES MAP ---
          const ruleMap = {
            // CSS RULES (Stylelint)
            'a11y/no-outline-none': 'WCAG 2.4.7 (Focus Visible)',
            'a11y/selector-pseudo-class-focus': 'WCAG 2.4.7 (Focus Visible)',
            'a11y/content-property-no-static-value': 'WCAG 1.3.1 (Info and Relationships)',
            'a11y/media-prefers-reduced-motion': 'WCAG 2.3.3 (Animation from Interactions)',
            'a11y/no-text-align-justify': 'WCAG 1.4.8 (Visual Presentation)',
            'a11y/font-size-is-readable': 'Best Practice (Readable Text)',

            // ANGULAR
            '@angular-eslint/template/alt-text': 'WCAG 1.1.1 (Non-text Content)',
            '@angular-eslint/template/click-events-have-key-events': 'WCAG 2.1.1 (Keyboard)',
            '@angular-eslint/template/mouse-events-have-key-events': 'WCAG 2.1.1 (Keyboard)',
            '@angular-eslint/template/label-has-associated-control': 'WCAG 1.3.1 (Info and Relationships)',

            // REACT / VUE / HTML (Condensed for brevity)
            'jsx-a11y/alt-text': 'WCAG 1.1.1',
            'jsx-a11y/anchor-has-content': 'WCAG 2.4.4',
            'jsx-a11y/click-events-have-key-events': 'WCAG 2.1.1',
            'jsx-a11y/label-has-associated-control': 'WCAG 1.3.1',
            'react-native-a11y/accessibility-label': 'WCAG 1.1.1',
            'vuejs-accessibility/alt-text': 'WCAG 1.1.1',
            'vuejs-accessibility/form-control-has-label': 'WCAG 1.3.1'
          };

          // --- 2. LOAD FILES ---
          const loadJSON = (path) => {
             if (!fs.existsSync(path)) return [];
             try { return JSON.parse(fs.readFileSync(path, 'utf8')); } 
             catch (e) { return []; }
          };

          const eslintRaw = loadJSON('eslint-raw.json');
          const stylelintRaw = loadJSON('stylelint-raw.json');

          // --- 3. NORMALIZE & MERGE ---
          // ESLint structure: [{ filePath, messages: [{ ruleId, message }] }]
          // Stylelint structure: [{ source, warnings: [{ rule, text }] }]
          
          const normalizedStylelint = stylelintRaw.map(file => ({
            filePath: file.source.split('/target-code/')[1] || file.source,
            messages: file.warnings.map(w => ({
              ruleId: w.rule,
              message: w.text,
              line: w.line,
              column: w.column,
              severity: 2
            }))
          }));

          const allFiles = [...eslintRaw, ...normalizedStylelint];

          // --- 4. FILTER & ENRICH ---
          const finalReport = allFiles.map(f => {
             const validMsgs = f.messages.filter(m => ruleMap[m.ruleId]);
             if (validMsgs.length === 0) return null;

             f.filePath = f.filePath.split('/target-code/')[1] || f.filePath;
             f.messages = validMsgs.map(m => ({
               ...m,
               wcagClause: ruleMap[m.ruleId]
             }));
             return f;
          }).filter(Boolean);

          fs.writeFileSync('accessibility-report.json', JSON.stringify(finalReport, null, 2));
          console.log(`âœ… Total Code Scan: ${finalReport.length} files with A11y issues.`);
          EOF

      - name: Run ESLint (JS/HTML)
        continue-on-error: true
        run: |
          npx eslint ./target-code \
          --config .eslintrc-universal.json \
          --no-eslintrc \
          --ext .js,.jsx,.ts,.tsx,.vue,.html \
          --resolve-plugins-relative-to . \
          --format json \
          -o eslint-raw.json

      - name: Run Stylelint (CSS/SCSS)
        continue-on-error: true
        run: |
          npx stylelint "./target-code/**/*.{css,scss,less,sass}" \
          --config .stylelintrc.json \
          --formatter json \
          --allow-empty-input \
          > stylelint-raw.json

      - name: Merge and Enrich Reports
        run: node map-wcag.js

      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.run_id }}
          path: accessibility-report.json
