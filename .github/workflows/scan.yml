name: üïµÔ∏è‚Äç‚ôÄÔ∏è Remote Accessibility Scanner

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: 'GitHub Repo URL to scan (e.g. https://github.com/user/repo)'
        required: true
        type: string

jobs:
  remote-scan:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout YOUR repo (to run this action)
      - name: Checkout Host Repo
        uses: actions/checkout@v4

      # 2. Setup Node.js (Environment for the scanner)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install Scanner Tools (Sidecar Approach)
      # We install the tools HERE, not in the target repo.
      # This ensures the scan works even if the target has no dependencies installed.
      - name: Install Scanner Engine
        run: |
          npm install eslint eslint-plugin-jsx-a11y eslint-plugin-vue-a11y eslint-plugin-react
          
      # 4. Clone the TARGET Repository
      - name: Clone Target Repository
        run: |
          git clone ${{ inputs.target_repo_url }} ./target-code

      # 5. Create Configs & Scripts on the Fly
      # We generate the ESLint config and the WCAG mapper dynamically
      - name: Generate Configurations
        run: |
          # --- Create ESLint Config ---
          cat << 'EOF' > .eslintrc-temp.json
          {
            "parserOptions": { "ecmaVersion": 2020, "sourceType": "module", "ecmaFeatures": { "jsx": true } },
            "plugins": ["jsx-a11y", "react"],
            "extends": ["plugin:jsx-a11y/strict"],
            "rules": {
              "react/jsx-uses-react": "off",
              "react/react-in-jsx-scope": "off"
            }
          }
          EOF

          # --- Create WCAG Mapper Script ---
          cat << 'EOF' > map-wcag.js
          const fs = require('fs');
          const ruleMap = {
            'jsx-a11y/alt-text': '1.1.1 (Non-text Content)',
            'jsx-a11y/anchor-has-content': '2.4.4 (Link Purpose)',
            'jsx-a11y/anchor-is-valid': '2.1.1 (Keyboard)',
            'jsx-a11y/click-events-have-key-events': '2.1.1 (Keyboard)',
            'jsx-a11y/heading-has-content': '1.3.1 (Info and Relationships)',
            'jsx-a11y/html-has-lang': '3.1.1 (Language of Page)',
            'jsx-a11y/iframe-has-title': '2.4.1 (Bypass Blocks)',
            'jsx-a11y/label-has-associated-control': '1.3.1 (Info and Relationships)',
            'jsx-a11y/media-has-caption': '1.2.2 (Captions)',
            'jsx-a11y/mouse-events-have-key-events': '2.1.1 (Keyboard)',
            'jsx-a11y/no-autofocus': '2.4.3 (Focus Order)',
            'jsx-a11y/tabindex-no-positive': '2.4.3 (Focus Order)'
          };
          
          try {
            if (!fs.existsSync('eslint-raw.json')) { console.log("No errors found."); process.exit(0); }
            const report = JSON.parse(fs.readFileSync('eslint-raw.json', 'utf8'));
            
            const enriched = report.map(f => {
              if (f.messages.length === 0) return null;
              // Clean up the file path to remove the ./target-code prefix for readability
              f.filePath = f.filePath.split('/target-code/')[1] || f.filePath;
              
              f.messages = f.messages.map(m => ({ 
                ...m, 
                wcagClause: ruleMap[m.ruleId] || 'Unmapped / Best Practice' 
              }));
              return f;
            }).filter(Boolean);
            
            fs.writeFileSync('accessibility-report.json', JSON.stringify(enriched, null, 2));
            console.log(`‚úÖ Report generated with ${enriched.length} files containing issues.`);
          } catch (e) { console.error("Error processing JSON:", e); }
          EOF

      # 6. Run the Scan
      # We scan the ./target-code folder using the config we just made
      - name: Execute Scan
        continue-on-error: true
        run: |
          npx eslint ./target-code \
          --config .eslintrc-temp.json \
          --no-eslintrc \
          --ext .js,.jsx,.ts,.tsx \
          --format json \
          -o eslint-raw.json

      # 7. Map to WCAG Clauses
      - name: Enrich with WCAG Data
        run: node map-wcag.js

      # 8. Upload Result
      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.run_id }}
          path: accessibility-report.json
